{% extends 'layouts/base.html' %}

{% block title %}Proyectos{% endblock %}
{% block page_title %}Gestión de Auditorías{% endblock %}
{% block page_subtitle %}
    {% if es_vista_nacional %}
        Portafolio Nacional
    {% else %}
        Vista Local / Mis Proyectos
    {% endif %}
{% endblock %}

{% block content %}
<div class="card-modern p-0 shadow-sm">
    
    <div class="p-4 border-bottom bg-white">
        <form method="get" class="row g-2 align-items-center">
            
            <div class="col-md-3">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-search"></i></span>
                    <input type="text" name="q" class="form-control bg-light border-start-0" 
                           placeholder="Buscar empresa o proyecto..." 
                           value="{{ filtro_actual_q }}">
                </div>
            </div>

            <div class="col-md-2">
                <select name="estado" class="form-select form-select-sm border-light bg-light fw-medium text-secondary" onchange="this.form.submit()">
                    <option value="">-- Estado --</option>
                    <option value="BORRADOR" {% if filtro_actual_estado == 'BORRADOR' %}selected{% endif %}>Borrador</option>
                    <option value="EJECUCION" {% if filtro_actual_estado == 'EJECUCION' %}selected{% endif %}>En Ejecución</option>
                    <option value="FINALIZADO" {% if filtro_actual_estado == 'FINALIZADO' %}selected{% endif %}>Finalizado</option>
                </select>
            </div>

            {% if es_vista_nacional %}
            <div class="col-md-3">
                <select name="centro" class="form-select form-select-sm border-light bg-light fw-medium text-secondary" onchange="this.form.submit()">
                    <option value="">-- Todos los Centros --</option>
                    {% for c in opciones_centros %}
                    <option value="{{ c.id }}" {% if filtro_actual_centro == c.id %}selected{% endif %}>
                        {{ c.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            {% if opciones_lideres %}
            <div class="col-md-3">
                <select name="lider" class="form-select form-select-sm border-light bg-light fw-medium text-secondary" onchange="this.form.submit()">
                    <option value="">-- Todos los Líderes --</option>
                    
                    <option value="{{ user.id }}" class="fw-bold text-primary" {% if filtro_actual_lider == user.id %}selected{% endif %}>
                        ★ Mis Proyectos
                    </option>
                    <option disabled>──────────</option>

                    {% for l in opciones_lideres %}
                        {% if l.id != user.id %}
                        <option value="{{ l.id }}" {% if filtro_actual_lider == l.id %}selected{% endif %}>
                            {{ l.get_full_name|default:l.username }}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="col text-end">
                {% if user.rol != 'ESTUDIANTE' %}
                <a href="{% url 'crear_proyecto' %}" class="btn btn-primary btn-sm rounded-pill shadow-sm fw-medium hover-lift">
                    <i class="bi bi-plus-lg"></i> <span class="d-none d-lg-inline">Nuevo</span>
                </a>
                {% endif %}
                
                {% if filtro_actual_q or filtro_actual_estado or filtro_actual_centro or filtro_actual_lider %}
                <a href="{% url 'lista_proyectos' %}" class="btn btn-light btn-sm rounded-circle border ms-1" title="Limpiar Filtros">
                    <i class="bi bi-x-lg text-muted"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="table-responsive" style="overflow: visible;">
        <table class="table-modern table-hover align-middle">
            <thead>
                <tr>
                    <th class="ps-4 text-uppercase text-secondary" style="font-size: 0.75rem;">Proyecto / Cliente</th>
                    <th class="text-uppercase text-secondary" style="font-size: 0.75rem;">Líder & Equipo</th>
                    {% if es_vista_nacional %}
                    <th class="text-uppercase text-secondary" style="font-size: 0.75rem;">Centro PEVI</th>
                    {% endif %}
                    <th class="text-uppercase text-secondary" style="font-size: 0.75rem;">Estado</th>
                    <th class="text-end pe-4"></th>
                </tr>
            </thead>
            <tbody>
                {% for p in proyectos %}
                <tr>
                    <td class="ps-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="rounded-3 bg-soft-primary text-primary d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="bi bi-folder2-open fs-5"></i>
                            </div>
                            <div>
                                <a href="{% url 'detalle_proyecto' p.id %}" class="fw-bold text-dark text-decoration-none hover-underline mb-0 text-truncate" style="max-width: 250px; display:block;">
                                    {{ p.nombre_proyecto }}
                                </a>
                                <div class="small text-muted">
                                    <i class="bi bi-building me-1"></i> {{ p.empresa.razon_social }}
                                </div>
                            </div>
                        </div>
                    </td>

                    <td>
                        {% if p.lider_proyecto %}
                            <div class="d-flex align-items-center mb-1">
                                {% if p.lider_proyecto == user %}
                                    <i class="bi bi-star-fill text-warning me-2"></i>
                                    <span class="small fw-bold text-dark">Yo (Líder)</span>
                                {% else %}
                                    <i class="bi bi-person-circle text-secondary me-2"></i>
                                    <span class="small fw-medium text-dark">{{ p.lider_proyecto.get_full_name|default:p.lider_proyecto.username }}</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="small text-muted fst-italic">Sin líder</span>
                        {% endif %}
                        
                        {% if p.equipo.count > 0 %}
                            <span class="badge bg-light text-secondary border rounded-pill" style="font-size: 0.65rem;">
                                +{{ p.equipo.count }}
                            </span>
                        {% endif %}
                    </td>

                    {% if es_vista_nacional %}
                    <td><span class="badge bg-light text-dark border">{{ p.centro.nombre }}</span></td>
                    {% endif %}

                    <td>
                        {% if p.estado == 'FINALIZADO' %}
                            <span class="badge bg-soft-success text-success border border-success-subtle rounded-pill px-3">Finalizado</span>
                        {% elif p.estado == 'EJECUCION' %}
                            <span class="badge bg-soft-primary text-primary border border-primary-subtle rounded-pill px-3">En Ejecución</span>
                        {% else %}
                            <span class="badge bg-soft-secondary text-secondary border rounded-pill px-3">{{ p.get_estado_display }}</span>
                        {% endif %}
                    </td>

                    <td class="text-end pe-4">
                        <a href="{% url 'detalle_proyecto' p.id %}" class="btn btn-light btn-sm border text-secondary fw-medium">Gestionar</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if es_vista_nacional %}5{% else %}4{% endif %}" class="text-center py-5">
                        <h6 class="fw-bold text-dark">No se encontraron proyectos</h6>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .hover-underline:hover { text-decoration: underline !important; color: #0284c7 !important; }
</style>
{% endblock %}