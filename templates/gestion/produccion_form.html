{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Definir Producción{% endblock %}
{% block page_title %}Contexto Productivo{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
        
        <div class="card card-modern border-0 shadow-lg overflow-hidden">
            
            <div class="bg-white p-4 border-bottom border-2">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <div class="rounded-circle bg-dark text-white p-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-boxes fs-4"></i>
                    </div>
                </div>
                <div class="text-center">
                    <h5 class="fw-bold text-dark mb-0">Definir Nivel de Actividad</h5>
                    <small class="text-muted">Indicador base para el desempeño energético (IDES)</small>
                </div>
            </div>

            <div class="p-5 bg-white">
                
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="alert alert-light border border-secondary border-opacity-25 mb-4">
                        <small class="d-block text-secondary fw-bold text-uppercase mb-1">PROYECTO</small>
                        <div class="fw-bold text-dark">{{ proyecto.nombre_proyecto }}</div>
                    </div>

                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label fw-bold text-dark small text-uppercase">Cantidad Producida (Año Base)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-graph-up-arrow"></i></span>
                                {{ form.produccion_total }}
                            </div>
                            <div class="form-text small text-muted">Total de unidades, toneladas o metros cuadrados procesados en el año.</div>
                            {% if form.produccion_total.errors %}
                                <div class="text-danger small mt-1">{{ form.produccion_total.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold text-dark small text-uppercase">Unidad de Medida</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-ruler"></i></span>
                                {{ form.unidad_produccion }}
                            </div>
                            <div class="form-text small text-muted">Ej: Toneladas, Pares de Zapatos, m² de Tela, Litros.</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-5 pt-3">
                        <button type="submit" class="btn btn-dark py-2 fw-bold shadow-sm">
                            <i class="bi bi-save me-2"></i> GUARDAR CONTEXTO
                        </button>
                        <a href="{% url 'detalle_proyecto' proyecto.id %}" class="btn btn-link text-decoration-none text-secondary">
                            Cancelar y volver
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const inputProd = document.querySelector("input[name='produccion_total']");
        const form = document.querySelector("form");
        
        // Función de formateo visual
        function formatNumber(n) {
            if(!n && n !== 0) return "";
            // Quitar comas previas y separar decimales
            let parts = n.toString().replace(/,/g, "").split(".");
            // Agregar comas a la parte entera
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }

        if(inputProd) {
            // 1. Configurar input como texto
            inputProd.setAttribute('type', 'text');
            inputProd.setAttribute('autocomplete', 'off');

            // 2. Formatear al cargar (si estamos editando)
            if(inputProd.value) inputProd.value = formatNumber(inputProd.value);

            // 3. Formatear mientras escribes
            inputProd.addEventListener('keyup', function(e) {
                if (e.key === "." || e.key === "Decimal" || e.key.startsWith("Arrow")) return;
                
                // Guardar posición del cursor para UX suave
                let originalLength = this.value.length;
                let cursorPosition = this.selectionStart;

                this.value = formatNumber(this.value);

                // Ajustar cursor
                let newLength = this.value.length;
                cursorPosition = cursorPosition + (newLength - originalLength);
                this.setSelectionRange(cursorPosition, cursorPosition);
            });

            // 4. LIMPIEZA AL ENVIAR (CRÍTICO)
            form.addEventListener('submit', function() {
                // Quitamos las comas justo antes de enviar
                inputProd.value = inputProd.value.replace(/,/g, "");
            });
        }
    });
</script>
{% endblock %}